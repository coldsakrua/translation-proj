# TEaR Refine步骤完善指南

## 概述

TEaR（Translate-Estimate-Refine）框架是一个翻译质量优化循环：
1. **Translate（翻译）**：生成初始译文
2. **Estimate（评估）**：评估译文质量，识别问题
3. **Refine（修正）**：基于评估反馈进行针对性修正

本次完善主要改进了**Refine步骤**，使其更加智能和有效。

## 改进内容

### 1. 增强的评估模型

**之前**：评估结果只包含简单的score、critique和pass_flag

**现在**：评估结果包含更详细的信息：
```python
class QualityReview(BaseModel):
    score: int  # 1-10分
    critique: str  # 总体评估意见
    pass_flag: bool  # 是否达标
    error_types: List[str]  # 错误类型列表（新增）
    specific_issues: List[str]  # 具体问题列表（新增）
    improvement_suggestions: List[str]  # 改进建议列表（新增）
```

**错误类型示例**：
- "术语不一致"
- "语义偏差"
- "语法错误"
- "流畅性问题"
- "风格不一致"

### 2. 专门的Refine节点

**之前**：质量不达标时，直接回到translate节点重新翻译

**现在**：创建了专门的`node_refine_translation`节点，进行针对性修正

**Refine节点的特点**：
- 基于详细的评估反馈进行修正
- 只修正发现的具体问题，不进行大幅改动
- 保留译文中正确的部分
- 严格遵循术语表
- 提供清晰的修正步骤指导

### 3. 修正历史记录

在`TranslationState`中添加了`refinement_history`字段，记录每次评估和修正的详细信息：

```python
refinement_history: List[Dict[str, Any]] = Field(default_factory=list)
```

每次评估后，会保存：
- 迭代次数
- 质量分数
- 评估意见
- 错误类型
- 具体问题
- 改进建议
- 回译文

### 4. 改进的工作流

**之前的工作流**：
```
translate -> evaluate -> (quality_gate) -> translate (如果质量不达标)
```

**现在的工作流**：
```
translate -> evaluate -> (quality_gate) -> refine -> evaluate -> ...
```

**改进点**：
- 质量不达标时，进入专门的refine节点
- refine完成后，重新进入evaluate节点
- 形成完整的TEaR循环

## 工作流程

### 完整流程

1. **Translate（翻译）**
   - 生成初始译文
   - 使用术语表和风格指南

2. **Estimate（评估）**
   - 回译验证
   - 多维度评估（术语一致性、语义准确性、回译一致性、语言流畅性、风格一致性）
   - 生成详细的评估报告（包括错误类型、具体问题、改进建议）

3. **Refine（修正）**
   - 基于评估反馈进行针对性修正
   - 只修正发现的问题
   - 保持译文的优点

4. **重新评估**
   - 对修正后的译文重新评估
   - 如果质量达标（>=7分）或达到最大迭代次数（3次），则保存
   - 否则继续refine循环

### Quality Gate逻辑

```python
def quality_gate(state: TranslationState):
    # 最大迭代次数：3次
    if state.revision_count >= 3:
        return "persistence"  # 强制保存
    
    # 质量达标：>=7分
    if state.quality_score >= 7:
        return "persistence"  # 保存
    
    # 质量不达标：进入refine
    return "refine"  # 修正
```

## 使用示例

### 评估输出示例

```json
{
    "score": 6,
    "pass_flag": false,
    "critique": "译文整体意思准确，但存在术语不一致和流畅性问题",
    "error_types": ["术语不一致", "流畅性问题"],
    "specific_issues": [
        "第3句中的'neural network'应翻译为'神经网络'，但使用了'神经元网络'",
        "第5句表达不够流畅，建议调整语序"
    ],
    "improvement_suggestions": [
        "将'神经元网络'统一改为'神经网络'",
        "调整第5句的语序，使其更符合中文表达习惯"
    ]
}
```

### Refine提示词结构

Refine节点使用结构化的提示词，包括：
1. **修正原则**：针对性修正、保持优点、术语一致性等
2. **评估反馈**：总体评估、错误类型、具体问题、改进建议
3. **术语表**：必须严格遵守
4. **风格要求**：保持风格一致
5. **修正步骤**：清晰的修正流程

## 优势

1. **针对性修正**：只修正发现的问题，不进行不必要的改动
2. **保留优点**：不会因为修正而破坏译文中正确的部分
3. **可追溯性**：完整的修正历史记录，便于分析和改进
4. **智能迭代**：基于详细反馈进行修正，提高修正效率
5. **质量保障**：多轮评估和修正，确保最终译文质量

## 技术细节

### 评估提示词改进

评估提示词现在要求：
- 识别5个维度的质量问题
- 提供结构化的错误类型
- 指出具体的问题位置和内容
- 提供可操作的改进建议

### Refine提示词设计

Refine提示词强调：
- **针对性**：只修正评估中发现的问题
- **保守性**：不要大幅改动
- **准确性**：确保修正后的译文准确
- **一致性**：严格遵循术语表

## 注意事项

1. **最大迭代次数**：设置为3次，防止无限循环
2. **质量阈值**：7分以上认为达标
3. **术语表优先级**：修正时必须严格遵守术语表
4. **回译参考**：使用回译文作为语义准确性参考

## 未来改进方向

1. **错误类型分类**：更细粒度的错误类型识别
2. **修正策略**：针对不同错误类型使用不同的修正策略
3. **学习机制**：从修正历史中学习，改进评估和修正能力
4. **人工介入**：在关键修正点提供人工审查选项

